#!/bin/bash

# update et installation du neccessaire
sudo apt-get update -y
 sudo apt-get install apache2 mariadb-server imagemagick php libapache2-mod-php php-imagick php7.4-common php7.4-mysql php7.4-gd php7.4-json php7.4-curl php7.4-zip php7.4-xml php7.4-mbstring php7.4-bz2 php7.4-intl php7.4-bcmath php7.4-gmp -y unzip

sudo systemctl start apache2
sudo systemctl enable apache2
#sudo systemctl status apache2

# config de php
sudo cp /sharedFolder/php.ini /etc/php/7.4/apache2/php.ini
sudo systemctl restart apache2

# Démarrer et configurer MySQL
sudo systemctl start mysql
    
# creer une BD pour projectsend
sudo mysql -e "CREATE DATABASE projectsend;"
sudo mysql -e "CREATE USER 'projectsend'@'localhost' IDENTIFIED BY 'password';"
sudo mysql -e "GRANT ALL PRIVILEGES ON projectsend.* TO 'projectsend'@'localhost';"
sudo mysql -e "FLUSH PRIVILEGES;"

# Télécharger une version vulnérable de ProjectSend
wget -q https://github.com/projectsend/projectsend/releases/download/r1420/projectsend-r1420.zip

# deployer sur apache
sudo unzip projectsend-r1420.zip -d /var/www/html/projectsend

# fichier de config defini pour le user de la BD projectsend 
sudo cp /sharedFolder/sys.config.php /var/www/html/projectsend/includes/sys.config.php
# fichier de config du site
sudo cp /sharedFolder/projectsend.conf /etc/apache2/sites-available/projectsend.conf 

# definir les droits
sudo chown -R www-data:www-data /var/www/html/projectsend
sudo chmod -R 775 /var/www/html/projectsend
sudo chmod 644 /var/www/html/projectsend/includes/sys.config.php

# lancer l'app
sudo a2enmod rewrite
sudo a2dissite 000-default.conf  # desactive config par defaut
sudo a2ensite projectsend.conf
sudo systemctl restart apache2

# netoyer le zip
rm projectsend-r1420.zip

echo "installation et configuration terminées ..."
sudo systemctl status apache2


